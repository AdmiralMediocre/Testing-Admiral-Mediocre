<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plants vs. Zombies ‚Äì Browser Clone</title>
  <style>
    :root{
      --bg:#6ec54c; --dark:#1f4121; --stone:#5a5a66; --ui:#2f2f3a; --gold:#ffd95e;
      --grass1:#66b34a; --grass2:#5aa441; --sky:#8fd3ff; --btn:#3b3b49; --btn-h:#505063;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    body{background:linear-gradient(var(--sky) 30%, #b5ecff 100%);}    
    button{cursor:pointer}
    .hidden{display:none!important}

    /* --- Main Menu --- */
    #menu{
      position:relative; height:100vh; width:100vw; overflow:hidden;
      background:linear-gradient(var(--sky) 45%, var(--grass1));
    }
    .house{position:absolute; left:6%; bottom:8%; width:260px; height:200px;}
    .house:before{content:""; position:absolute; inset:0; border-radius:16px; background:#fff8e6; box-shadow:inset 0 0 0 3px #cfa, 0 8px 0 #a455;}
    .house:after{content:""; position:absolute; left:30px; top:-40px; width:160px; height:80px; background:#d66; border-radius:6px 6px 20px 20px; box-shadow:0 8px #b44}
    .tomb{
      position:absolute; right:8%; bottom:6%; width:460px; background:#4e4e59; color:#eef; border-radius:40px; padding:28px 24px 36px; box-shadow:inset 0 -10px 0 #383844, inset 0 0 0 6px #70707e; transform:skew(-2deg);
    }
    .tomb h2{margin:0 0 8px; text-align:center; letter-spacing:2px}
    .tomb .slab{display:block; margin:12px auto; max-width:360px; padding:14px 20px; background:#3c3c48; color:#e9ecff; border-radius:12px; font-weight:900; font-size:24px; text-align:center; text-transform:uppercase; letter-spacing:2px; border:4px solid #6f6f82; text-shadow:0 2px #23232c;}
    .tomb .slab:hover{background:#47475a}
    .menu-row{position:absolute; right:10%; bottom:2%; display:flex; gap:12px}
    .pill{background:#e9e1c3; border-radius:24px; padding:6px 12px; border:2px solid #bdb38e; font-weight:700}
    .pill:hover{filter:brightness(1.05)}
    .badge{position:absolute; left:6%; top:6%; background:#2d522d; color:#d4ffcf; padding:10px 16px; border-radius:12px; font-weight:800; box-shadow:0 3px 0 #173017}
    .zombatar{position:absolute; left:6%; top:20%; background:#663; color:#ffd; font-weight:900; padding:10px 14px; border-radius:10px; transform:rotate(-3deg)}
    .golden{position:absolute; left:6%; bottom:8%; display:flex; align-items:center; gap:10px}
    .trophy{width:70px; height:70px; background:radial-gradient(circle at 30% 30%, #fff6b0, #ffc83d); border-radius:12px; box-shadow:0 8px 0 #caa600}

    /* --- HUD --- */
    #game, #deck, #overlay{position:absolute; inset:0}
    #gamewrap{position:relative; height:100vh; display:none}
    #hud{position:absolute; left:0; top:0; right:0; height:64px; display:flex; align-items:center; gap:10px; padding:6px 10px; background:linear-gradient(#e6f9c2,#c7efa1); border-bottom:4px solid #9ad36f}
    #sunBox{font-weight:900; padding:6px 12px; background:#fff; border-radius:8px; border:3px solid #6ab04c}
    #levelBox{margin-left:auto; font-weight:800}
    #musicBtn{margin-left:6px}

    /* --- Seed bank --- */
    #deck{top:64px; height:96px; background:#2c2f3b; display:flex; align-items:center; gap:8px; padding:8px 12px; border-bottom:4px solid #222531}
    .seed{width:78px; height:78px; background:#f4f4f4; border-radius:10px; border:3px solid #a5a5a5; position:relative; display:flex; align-items:center; justify-content:center; font-size:12px; text-align:center; padding:4px}
    .seed.locked{filter:grayscale(1) brightness(.7)}
    .seed .cost{position:absolute; left:4px; top:4px; background:#ffe37a; border:2px solid #d8b400; border-radius:8px; padding:1px 6px; font-weight:800}
    .seed .cool{position:absolute; right:4px; bottom:4px; font-size:10px; opacity:.8}

    /* --- Lawn --- */
    #lawn{position:absolute; left:0; right:0; top:160px; bottom:0; background:repeating-linear-gradient(90deg, #6bb24a 0 80px, #70ba4f 80px 160px); border-top:6px solid #487c36}
    canvas{display:block; width:100%; height:100%}

    /* --- Panels --- */
    #plantPicker{position:absolute; top:64px; left:0; right:0; bottom:0; background:#0008; display:flex; align-items:center; justify-content:center}
    .picker{width:min(980px,92vw); background:#1f2632; color:#e8f0ff; border-radius:16px; border:4px solid #4e6079; padding:16px}
    .picker h3{margin:0 0 10px}
    .grid{display:grid; grid-template-columns:repeat(9,1fr); gap:8px}
    .pick{background:#f4f6ff; color:#222; border:3px solid #a5b5d0; border-radius:12px; padding:6px; height:84px; display:flex; align-items:center; justify-content:center; position:relative}
    .pick.locked{filter:grayscale(1) brightness(.7); pointer-events:none}
    .pick .name{font-weight:800; font-size:12px; text-align:center}
    .pick .price{position:absolute; left:6px; top:6px; background:#ffe37a; border:2px solid #d8b400; border-radius:8px; padding:1px 6px; font-weight:800}
    .selectedBar{display:flex; gap:6px; margin-top:12px}
    .slot{flex:1; height:42px; background:#e7ebff; border:3px dashed #9fb2df; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700}
    .slot.filled{border-style:solid; background:#fff}
    .picker .row{display:flex; justify-content:space-between; align-items:center; margin-top:12px}
    .btn{background:var(--btn); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:800}
    .btn:hover{background:var(--btn-h)}

    /* Toast */
    #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#000b; color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; opacity:0; transition:.4s}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <!-- === MAIN MENU === -->
  <section id="menu">
    <div class="badge">WELCOME BACK,<br><span id="playerName">GARDENER</span>!</div>
    <div class="zombatar">ZOMBATAR! Make your own zombie</div>
    <div class="house"></div>
    <div class="golden"><div class="trophy"></div><div><b>ACHIEVEMENTS</b><br><small>(coming soon)</small></div></div>

    <div class="tomb">
      <h2>LEVEL <span id="menuLevel">1-1</span></h2>
      <button class="slab" id="btnAdventure">ADVENTURE</button>
      <button class="slab" disabled>MINI-GAMES</button>
      <button class="slab" disabled>PUZZLE</button>
      <button class="slab" disabled>SURVIVAL</button>
    </div>
    <div class="menu-row">
      <button class="pill" id="btnShop">SHOP</button>
      <button class="pill" id="btnOptions">OPTIONS</button>
      <button class="pill" id="btnHelp">HELP</button>
      <button class="pill" id="btnQuit">QUIT</button>
    </div>
  </section>

  <!-- === GAME WRAP === -->
  <section id="gamewrap">
    <div id="hud">
      <div id="sunBox">‚òÄÔ∏è <span id="sun">150</span></div>
      <div id="levelBox">Level <span id="levelText">1-1</span> ‚Äî Select up to 9 plants</div>
      <button id="musicBtn" class="btn">üéµ Play Music</button>
      <button id="muteBtn" class="btn hidden">üîá Mute</button>
    </div>
    <div id="deck"></div>
    <div id="lawn"><canvas id="game"></canvas></div>

    <!-- Plant Picker Overlay -->
    <div id="plantPicker" class="hidden">
      <div class="picker">
        <h3>Pick your seed packets (up to 9)</h3>
        <div class="grid" id="pickGrid"></div>
        <div class="selectedBar" id="selectedBar"></div>
        <div class="row">
          <div><b>Unlocked:</b> <span id="unlockedCount">1</span>/25</div>
          <div>
            <button id="clearPicks" class="btn">Clear</button>
            <button id="startLevel" class="btn">Start!</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- YouTube music (created on demand) -->
  <div id="yt-holder" class="hidden"></div>

<script>
/* =====================================================
   Plants vs. Zombies ‚Äì tiny, browser-friendly clone
   Single-file HTML. No external images ‚Äì all canvas.
   - 25 plants (some simplified), unlock 1 per level.
   - 9 seed slots, plant picker, sun economy.
   - A few zombie archetypes. Easier gameplay.
   - Looping music via YouTube IFrame API after user click.
   ===================================================== */
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const W = 9, H = 5, TILE = 80; // logical grid
  let level = parseInt(localStorage.getItem('pvz_level')||'1');
  let unlocked = Math.min(25, level); // unlock one plant per level cleared
  let selectedIds = [];
  let sun = 150;
  let waveTimer = 0;
  let gameStarted = false;

  // Update menu display
  $('#menuLevel').textContent = `1-${level}`;

  // Canvas and sizing
  const canvas = $('#game');
  const ctx = canvas.getContext('2d');
  function resize(){
    const lawn = $('#lawn');
    const r = lawn.getBoundingClientRect();
    canvas.width = r.width * devicePixelRatio;
    canvas.height = r.height * devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  addEventListener('resize', resize);

  /* -------------------- Assets (Procedural) -------------------- */
  const colors = {
    pea:'#6ac34a', ice:'#b7e7ff', fire:'#ff8c2a', wall:'#9b6a3a', nut:'#c48e55', shroom:'#a060d0'
  };
  function drawPlant(p){
    const {x,y,type,hp} = p; const gx=x*TILE+TILE/2, gy=y*TILE+TILE/2 + 180; // shift for HUD/deck
    ctx.save();
    ctx.translate(gx, gy);
    // little bob animation
    const t = performance.now()/400; const bob = Math.sin(t+ x*0.5 + y*0.3)*2;
    ctx.translate(0, bob);
    // body
    ctx.fillStyle = '#3d8d3d'; ctx.beginPath(); ctx.ellipse(0,20,12,24,0,0,Math.PI*2); ctx.fill();
    // head by type
    ctx.beginPath();
    if(type==='sunflower'||type==='twin'||type==='puff'||type==='gloom'||type==='scaredy'){
      ctx.fillStyle = '#ffd45e'; ctx.arc(0,0,18,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#f0a';
    }else if(type==='wallnut'||type==='tallnut'){ ctx.fillStyle=colors.nut; ctx.fillRect(-18,-20,36,40); }
    else if(type==='snow'){ ctx.fillStyle=colors.ice; ctx.beginPath(); ctx.arc(0,0,16,0,6.28); ctx.fill(); }
    else if(type==='cherry'){ ctx.fillStyle='#ff4d4d'; ctx.beginPath(); ctx.arc(-8,0,14,0,6.28); ctx.arc(12,-4,12,0,6.28); ctx.fill(); }
    else if(type==='spike'){ ctx.fillStyle='#6b4c2d'; ctx.fillRect(-20,6,40,8); }
    else { ctx.fillStyle='#7bdc3a'; ctx.beginPath(); ctx.arc(0,0,16,0,6.28); ctx.fill(); }
    // eyes
    ctx.fillStyle='#000'; ctx.fillRect(-6,-4,4,4); ctx.fillRect(3,-4,4,4);
    // HP bar
    ctx.fillStyle = '#0006'; ctx.fillRect(-20,26,40,6); ctx.fillStyle = '#6f6';
    ctx.fillRect(-20,26,40*(hp/p.maxHp),6);
    ctx.restore();
  }
  function drawZombie(z){
    const gx=z.x, gy=z.y*TILE+TILE/2+180;
    ctx.save(); ctx.translate(gx,gy);
    const bob=Math.sin(performance.now()/300+z.y)*2; ctx.translate(0,bob);
    ctx.fillStyle='#8bb5a3'; ctx.fillRect(-14,-26,28,34); // head
    ctx.fillStyle='#556'; ctx.fillRect(-16,8,32,24); // body
    // cone/bucket
    if(z.type==='cone') { ctx.fillStyle:'#f77'; ctx.beginPath(); ctx.moveTo(-16,-28); ctx.lineTo(0,-50); ctx.lineTo(16,-28); ctx.closePath(); ctx.fill(); }
    if(z.type==='bucket') { ctx.fillStyle:'#aaa'; ctx.fillRect(-18,-36,36,10); }
    // door
    if(z.type==='door'){ ctx.fillStyle:'#a76'; ctx.fillRect(-22,-6,12,28); }
    ctx.restore();
  }

  /* -------------------- Game State -------------------- */
  const grid = []; // [y][x] -> plant or null
  for(let y=0;y<H;y++){ grid[y]=Array(W).fill(null); }
  const projectiles=[]; const suns=[]; const zombies=[]; const effects=[];

  function rand(a,b){return Math.random()*(b-a)+a}
  function chance(p){return Math.random()<p}
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

  /* -------------------- Plants -------------------- */
  const PLANTS=[
    {id:'sunflower', name:'Sunflower', cost:50, cool:4, desc:'Generates sun.', maxHp:300, action(p){ if(p.timer%240===0){ spawnSun(p.x,p.y,25); } }},
    {id:'peashooter', name:'Peashooter', cost:100, cool:4, desc:'Shoots peas.', maxHp:300, action(p){ if(p.timer%50===0) shoot(p,1,'pea'); }},
    {id:'wallnut', name:'Wall-nut', cost:50, cool:6, desc:'Sturdy wall.', maxHp:1200, action(p){}},
    {id:'snow', name:'Snow Pea', cost:175, cool:5, desc:'Slows zombies.', maxHp:300, action(p){ if(p.timer%60===0) shoot(p,1,'ice'); }},
    {id:'potato', name:'Potato Mine', cost:25, cool:6, desc:'Arms then explodes.', maxHp:100, arm:600, action(p){ if(p.timer>p.arm){ let hit=zombies.find(z=>Math.abs(z.x-(p.x*TILE+TILE/2+120))<30 && z.y===p.y); if(hit){ areaDamage(p.x,p.y,150,120); removePlant(p.x,p.y); effectBoom(p.x,p.y); } } }},
    {id:'cherry', name:'Cherry Bomb', cost:150, cool:7, desc:'Big explosion.', maxHp:150, action(p){ if(p.timer===60){ areaDamage(p.x,p.y,220,200); removePlant(p.x,p.y); effectBoom(p.x,p.y); }}},
    {id:'repeater', name:'Repeater', cost:200, cool:5, desc:'Double peas.', maxHp:300, action(p){ if(p.timer%48===0){ shoot(p,1,'pea'); shoot(p,1,'pea',8); }}},
    {id:'puff', name:'Puff-shroom', cost:0, cool:3, desc:'Short range.', maxHp:150, action(p){ if(p.timer%38===0) shoot(p,0.45,'pea'); }},
    {id:'fume', name:'Fume-shroom', cost:75, cool:5, desc:'Piercing puff.', maxHp:250, action(p){ if(p.timer%60===0) shoot(p,0.9,'fume',{pierce:true, speed:3}); }},
    {id:'scaredy', name:'Scaredy', cost:25, cool:4, desc:'Hides up close.', maxHp:200, action(p){ const close=zombies.some(z=>z.y===p.y && z.x<(p.x*TILE+TILE*2)); if(!close && p.timer%60===0) shoot(p,1,'pea'); }},
    {id:'squash', name:'Squash', cost:50, cool:6, desc:'Squashes nearby.', maxHp:250, action(p){ const z=zombies.find(z=>z.y===p.y && Math.abs(z.x-(p.x*TILE+TILE/2+120))<80); if(z){ z.hp-=999; removePlant(p.x,p.y); effectBoom(p.x,p.y,0.7); }}},
    {id:'spike', name:'Spikeweed', cost:100, cool:6, desc:'Damages on step.', maxHp:250, action(p){ zombies.forEach(z=>{ if(z.y===p.y && Math.abs(z.x-(p.x*TILE+TILE/2+120))<30) z.hp-=0.3; }); }},
    {id:'threep', name:'Threepeater', cost:325, cool:6, desc:'Shoots 3 lanes.', maxHp:300, action(p){ if(p.timer%60===0){ [p.y-1,p.y,p.y+1].forEach(row=>{ if(row>=0&&row<H) shoot({...p,y:row},1,'pea'); }); }}},
    {id:'tallnut', name:'Tall-nut', cost:125, cool:7, desc:'Very sturdy.', maxHp:2400, action(p){}},
    {id:'torch', name:'Torchwood', cost:75, cool:5, desc:'Peas become fire.', maxHp:300, aura:'fire'},
    {id:'cabbage', name:'Cabbage-pult', cost:100, cool:5, desc:'Lobs cabbages.', maxHp:300, action(p){ if(p.timer%75===0) shoot(p,1,'pea',{arc:true}); }},
    {id:'kernel', name:'Kernel-pult', cost:100, cool:6, desc:'Butter stuns.', maxHp:300, action(p){ if(p.timer%80===0){ const proj=shoot(p,1,'pea',{arc:true}); if(chance(0.2)) proj.onHit=(z)=>{z.slow=0.4; z.slowT=180;}; } }},
    {id:'melon', name:'Melon-pult', cost:300, cool:7, desc:'Heavy lob.', maxHp:300, action(p){ if(p.timer%90===0){ const pr=shoot(p,1.4,'pea',{arc:true}); pr.damage=40; }}},
    {id:'garlic', name:'Garlic', cost:50, cool:5, desc:'Diverts zombies.', maxHp:300, action(p){ zombies.forEach(z=>{ const gx=p.x*TILE+TILE/2+120; if(z.y===p.y && Math.abs(z.x-gx)<26){ z.y = (z.y + (Math.random()<0.5?-1:1)+H)%H; z.x+=20; z.hp-=5; }}); }},
    {id:'chomper', name:'Chomper', cost:150, cool:6, desc:'Eats one zombie.', maxHp:300, action(p){ const z=zombies.find(z=>z.y===p.y && Math.abs(z.x-(p.x*TILE+TILE/2+120))<55); if(z){ z.hp-=999; p.sleep=360; } if(p.sleep>0) p.sleep--; }},
    {id:'twin', name:'Twin Sunflower', cost:125, cool:5, desc:'More sun.', maxHp:300, action(p){ if(p.timer%180===0){ spawnSun(p.x,p.y,50); } }},
    {id:'gloom', name:'Gloom-shroom', cost:125, cool:6, desc:'AOE close.', maxHp:300, action(p){ if(p.timer%70===0){ zombies.forEach(z=>{ if(Math.abs(z.x-(p.x*TILE+TILE/2+120))<90 && Math.abs(z.y-p.y)<=1) z.hp-=8; }); effectBoom(p.x,p.y,0.5); } }},
    {id:'iceshroom', name:'Ice-shroom', cost:75, cool:7, desc:'Freeze screen.', maxHp:1, action(p){ if(p.timer===30){ zombies.forEach(z=>{ z.slow=0.2; z.slowT=220; }); removePlant(p.x,p.y); effectBoom(p.x,p.y,0.8);} }},
    {id:'coffee', name:'Coffee Bean', cost:0, cool:4, desc:'(flavor)', maxHp:50, action(p){}},
    {id:'plantern', name:'Plantern', cost:25, cool:4, desc:'(flavor)', maxHp:250, action(p){}},
    {id:'pumpkin', name:'Pumpkin', cost:125, cool:7, desc:'Shield.', maxHp:600, action(p){}},
  ];
  const plantIndex = Object.fromEntries(PLANTS.map((p,i)=>[p.id,i]));

  /* -------------------- Zombies -------------------- */
  function makeZombie(type,y){
    const base = {type,x:900,y, hp:60, speed:0.25, eat:0, slow:1, slowT:0};
    if(type==='cone'){ base.hp=140; }
    if(type==='bucket'){ base.hp=260; }
    if(type==='runner'){ base.speed=0.45; base.hp=50; }
    if(type==='door'){ base.hp=160; }
    return base;
  }

  /* -------------------- Projectiles & Suns -------------------- */
  function shoot(p,range=1,type='pea',extra={}){
    const px=p.x*TILE+TILE/2+120, py=p.y*TILE+TILE/2+180;
    const proj = {x:px+15, y:py-10, v: (extra.arc?3:4.2), type, damage: (type==='ice'?18:20), row:p.y, pierce:!!extra.pierce, arc:!!extra.arc, t:0, onHit:null};
    if(hasTorchInFront(p)) { proj.type='fire'; proj.damage+=10; }
    projectiles.push(proj); return proj;
  }
  function hasTorchInFront(p){
    for(let x=p.x+1;x<W;x++){ const t=grid[p.y][x]; if(!t) continue; if(t.type==='torch') return true; if(t) return false; }
    return false;
  }
  function spawnSun(x,y,amount){
    suns.push({x:x*TILE+rand(100,160), y:y*TILE+rand(200,240), vy:-0.2, t:0, amount});
  }
  function effectBoom(x,y,scale=1){ effects.push({x:x*TILE+TILE/2+120, y:y*TILE+TILE/2+180, t:0, scale}); }

  /* -------------------- Planting -------------------- */
  let currentSeed = null; const cools={};
  function placePlant(ix,iy){
    if(!currentSeed) return;
    const def = PLANTS[currentSeed];
    if(grid[iy][ix]) { toast('Tile occupied'); return; }
    if(sun < def.cost){ toast('Not enough sun'); return; }
    if(cools[def.id] && cools[def.id]>0){ toast('Cooling down‚Ä¶'); return; }
    sun -= def.cost; updateHUD();
    const plant = {x:ix,y:iy,type:def.id,hp:def.maxHp,timer:0,maxHp:def.maxHp,sleep:0};
    grid[iy][ix]=plant;
    cools[def.id]=Math.round(def.cool*60);
  }
  function removePlant(x,y){ grid[y][x]=null; }

  /* -------------------- Waves -------------------- */
  function spawnWave(t){
    if(t%1600===0) zombies.push(makeZombie('basic', (Math.random()*H)|0));
    if(t%1200===0) zombies.push(makeZombie('cone', (Math.random()*H)|0));
    if(t%2000===0) zombies.push(makeZombie('bucket', (Math.random()*H)|0));
    if(t%1500===0) zombies.push(makeZombie('runner', (Math.random()*H)|0));
    if(t%2200===0) zombies.push(makeZombie('door', (Math.random()*H)|0));
  }

  /* -------------------- Rendering & Game Loop -------------------- */
  let tAll=0; let won=false;
  function update(){
    if(!gameStarted) return;
    tAll++;
    // cooldowns
    for(const k in cools){ if(cools[k]>0) cools[k]--; }
    // random falling sun for easier play
    if(tAll%240===0) suns.push({x:rand(120, W*TILE+120), y:rand(180, H*TILE+180), vy:rand(-0.6,-0.2), t:0, amount:25});

    // Waves
    waveTimer++; spawnWave(waveTimer);

    // Plants
    for(let y=0;y<H;y++) for(let x=0;x<W;x++){
      const p=grid[y][x]; if(!p) continue; p.timer++;
      const def = PLANTS[plantIndex[p.type]];
      def.action && def.action(p);
    }

    // Projectiles
    for(let i=projectiles.length-1;i>=0;i--){ const pr=projectiles[i]; pr.t++;
      if(pr.arc){ pr.x = pr.x + pr.v; pr.y = pr.y + Math.sin(pr.t/20)*1.6; }
      else pr.x += pr.v;
      const hits = zombies.filter(z=> Math.abs(z.y-pr.row)<0.1 && Math.abs(z.x-pr.x)<16 );
      if(hits.length){
        for(const z of hits){ let dmg=pr.damage; if(pr.type==='ice'){ z.slow=0.6; z.slowT=200; }
          z.hp -= dmg; if(pr.onHit) pr.onHit(z);
          if(!pr.pierce){ projectiles.splice(i,1); break; }
        }
      }
      if(pr.x>1000) projectiles.splice(i,1);
    }

    // Zombies
    for(let i=zombies.length-1;i>=0;i--){ const z=zombies[i];
      // slow timer
      if(z.slowT>0){ z.slowT--; if(z.slowT===0) z.slow=1; }
      // check collision with plants
      const gx = Math.floor((z.x-120)/TILE);
      const gy = z.y;
      if(gx>=0 && gx<W){ const p=grid[gy][gx]; if(p){ z.eating=true; z.x-=0.02; p.hp-=0.4; if(p.hp<=0) removePlant(gx,gy); }
        else { z.x -= 0.2*z.slow; }
      } else { z.x -= 0.25*z.slow; }
      if(z.hp<=0){ zombies.splice(i,1); // drop sun sometimes
        if(chance(0.15)) suns.push({x:z.x, y:z.y*TILE+200, vy:-0.4, t:0, amount:25});
      }
      if(z.x<80){ lose(); return; }
    }

    // Suns
    for(let i=suns.length-1;i>=0;i--){ const s=suns[i]; s.t++; s.y += s.vy; if(s.t>900) suns.splice(i,1); }

    // Effects
    for(let i=effects.length-1;i>=0;i--){ const e=effects[i]; e.t++; if(e.t>30) effects.splice(i,1); }

    // Win condition: survive tAll frames
    if(tAll> 60*90 && zombies.length===0){ win(); }
  }

  function render(){
    if(!gameStarted){ requestAnimationFrame(render); return; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // draw grid lines
    ctx.save(); ctx.translate(120,180); // left/top padding for lawn
    ctx.strokeStyle='rgba(0,0,0,.08)';
    for(let x=0;x<=W;x++){ ctx.beginPath(); ctx.moveTo(x*TILE,0); ctx.lineTo(x*TILE,H*TILE); ctx.stroke(); }
    for(let y=0;y<=H;y++){ ctx.beginPath(); ctx.moveTo(0,y*TILE); ctx.lineTo(W*TILE,y*TILE); ctx.stroke(); }
    ctx.restore();

    // plants
    for(let y=0;y<H;y++) for(let x=0;x<W;x++){ const p=grid[y][x]; if(p) drawPlant(p); }

    // projectiles
    projectiles.forEach(pr=>{ ctx.fillStyle= pr.type==='ice'?colors.ice: (pr.type==='fire'?colors.fire:colors.pea); ctx.beginPath(); ctx.arc(pr.x,pr.y,6,0,6.28); ctx.fill(); });

    // zombies
    zombies.forEach(drawZombie);

    // suns
    suns.forEach(s=>{ ctx.fillStyle='#ffd95e'; ctx.beginPath(); ctx.arc(s.x,s.y,12,0,6.28); ctx.fill(); ctx.fillStyle='#0008'; ctx.fillText(s.amount+'', s.x-6, s.y+4); });

    // effects
    effects.forEach(e=>{ ctx.save(); ctx.translate(e.x,e.y); ctx.scale(e.scale||1,e.scale||1); ctx.globalAlpha = 1 - e.t/30; ctx.fillStyle='#fff4a0'; ctx.beginPath(); ctx.arc(0,0, e.t*4, 0, 6.28); ctx.fill(); ctx.restore(); });

    requestAnimationFrame(render);
  }

  /* -------------------- Win/Lose -------------------- */
  function win(){ if(won) return; won=true; toast('Level complete! New plant unlocked.');
    level++; localStorage.setItem('pvz_level', level); setTimeout(()=>{ location.reload(); },1200); }
  function lose(){ toast('Zombies ate your brains!'); setTimeout(()=>{ location.reload(); },1200); }

  /* -------------------- Input -------------------- */
  $('#lawn').addEventListener('click', e=>{
    const r = $('#lawn').getBoundingClientRect();
    const x = Math.floor((e.clientX - r.left - 120)/TILE);
    const y = Math.floor((e.clientY - r.top - 180)/TILE);
    if(x>=0 && x<W && y>=0 && y<H) placePlant(x,y);
    // collect suns
    const sx=e.clientX, sy=e.clientY; const picked = suns.findIndex(s=> Math.hypot((s.x)-(sx), (s.y)-(sy))<24 );
    if(picked>=0){ sun+=suns[picked].amount; suns.splice(picked,1); updateHUD(); }
  });

  function updateHUD(){ $('#sun').textContent = Math.max(0,Math.floor(sun)); }

  /* -------------------- Seed Picker & Deck -------------------- */
  function openPicker(){
    $('#plantPicker').classList.remove('hidden');
    buildPickGrid(); renderSelectedBar();
  }
  function buildPickGrid(){
    const gridEl=$('#pickGrid'); gridEl.innerHTML='';
    PLANTS.forEach((p,i)=>{
      const div=document.createElement('div'); div.className='pick'+(i>=unlocked?' locked':'');
      div.innerHTML=`<div class="price">${p.cost}</div><div class="name">${p.name}</div>`;
      if(i<unlocked){ div.addEventListener('click',()=>pickPlant(i)); }
      gridEl.appendChild(div);
    });
    $('#unlockedCount').textContent = unlocked;
  }
  function pickPlant(i){
    if(selectedIds.includes(i)){ selectedIds = selectedIds.filter(x=>x!==i); }
    else {
      if(selectedIds.length>=9){ toast('All 9 slots are filled'); return; }
      selectedIds.push(i);
    }
    renderSelectedBar();
  }
  function renderSelectedBar(){
    const bar=$('#selectedBar'); bar.innerHTML='';
    for(let i=0;i<9;i++){
      const slot=document.createElement('div'); slot.className='slot'+(selectedIds[i]!==undefined?' filled':'');
      slot.textContent = selectedIds[i]!==undefined? PLANTS[selectedIds[i]].name : 'Empty';
      bar.appendChild(slot);
    }
  }
  function buildDeck(){
    const deck=$('#deck'); deck.innerHTML=''; currentSeed=null;
    selectedIds.forEach(i=>{
      const p=PLANTS[i]; const d=document.createElement('div'); d.className='seed';
      d.innerHTML=`<div class="cost">${p.cost}</div><div>${p.name}</div><div class="cool" id="cool-${p.id}">Ready</div>`;
      d.addEventListener('click',()=>{ currentSeed=i; toast(p.name+' selected'); });
      deck.appendChild(d);
    });
  }
  $('#clearPicks').onclick = ()=>{ selectedIds=[]; renderSelectedBar(); };
  $('#startLevel').onclick = ()=>{
    if(selectedIds.length===0){ toast('Pick at least one plant'); return; }
    $('#plantPicker').classList.add('hidden');
    buildDeck(); startGame(); };

  /* -------------------- Game Start -------------------- */
  function startGame(){
    gameStarted=true; sun=150; waveTimer=0; tAll=0; won=false; updateHUD();
    resize(); render();
  }

  // Adventure click -> open plant picker
  $('#btnAdventure').onclick = ()=>{
    $('#menu').style.display='none'; $('#gamewrap').style.display='block';
    $('#levelText').textContent = `1-${level}`; openPicker();
  };

  /* -------------------- Music: YouTube loop -------------------- */
  let ytPlayer=null; let ytReady=false; let musicOn=false;
  function ensureYouTubeAPI(){
    if(ytReady) return; ytReady=true;
    const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.body.appendChild(tag);
    window.onYouTubeIframeAPIReady = ()=>{
      ytPlayer = new YT.Player('yt-holder',{
        height:'0', width:'0', videoId:'IVjxtiAZsBQ', playerVars:{
          autoplay:0, controls:0, disablekb:1, fs:0, modestbranding:1, rel:0, loop:1, playlist:'IVjxtiAZsBQ'
        }, events:{ onReady:()=>{}, onStateChange:(e)=>{} }
      });
    };
  }
  $('#musicBtn').onclick = ()=>{ ensureYouTubeAPI(); const int=setInterval(()=>{
      if(ytPlayer && ytPlayer.playVideo){ ytPlayer.playVideo(); ytPlayer.setVolume(60); musicOn=true; $('#musicBtn').classList.add('hidden'); $('#muteBtn').classList.remove('hidden'); clearInterval(int);} },200);
  };
  $('#muteBtn').onclick = ()=>{ if(!ytPlayer) return; if(musicOn){ ytPlayer.mute(); musicOn=false; $('#muteBtn').textContent='üîä Unmute'; } else { ytPlayer.unMute(); musicOn=true; $('#muteBtn').textContent='üîá Mute'; } };

  /* -------------------- Utility: Area damage -------------------- */
  function areaDamage(cx,cy,px,damage){
    const gx=cx*TILE+TILE/2+120, gy=cy*TILE+TILE/2+180;
    zombies.forEach(z=>{ if(Math.hypot(z.x-gx, z.y*TILE+180-gy)<px) z.hp-=damage; });
  }

  /* -------------------- Main Menu other buttons -------------------- */
  $('#btnHelp').onclick=()=>alert('Plant seeds to stop zombies. Collect sun to buy more plants. Beat a level to unlock a new plant. This clone is simplified for the browser and made easier than the original.');
  $('#btnOptions').onclick=()=>alert('Options coming soon. Music can be controlled in-game.');
  $('#btnShop').onclick=()=>alert('Crazy Dave is on vacation. (Shop WIP)');
  $('#btnQuit').onclick=()=>location.reload();

  // init
  resize();
})();
</script>
</body>
</html>
